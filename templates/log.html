<!DOCTYPE html>
<html>
<head>
    <title>Data Logger</title>
    <style>
        body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
        h1 { text-align: center; }
        .section { margin-bottom: 20px; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            font-size: 18px; 
            border-radius: 8px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        .submit-btn { background: green; width: 100%; margin-top: 20px; }
        .success { color: green; font-size: 20px; margin-top: 15px; text-align: center; }
        nav a { margin-right: 20px; }
        .hint { color: #666; font-size: 14px; text-align: center; margin-top: 8px; }
        .navbar { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .nav-btn {
            padding: 10px 18px; background: #007bff; color: white;
            font-weight: bold; border-radius: 8px; text-decoration: none;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .nav-btn:hover { background: #0056b3; transform: translateY(-2px); }
        .nav-btn.active { background: #0056b3; border: 2px solid white; }
    </style>
</head>

<body>

<nav class="navbar">
  <a href="/log" class="nav-btn {% if request.path == '/log' %}active{% endif %}">Log Data</a>
  <a href="/dashboard" class="nav-btn {% if request.path == '/dashboard' %}active{% endif %}">Dashboard</a>
</nav>

<h1>Migration Game Logger</h1>

{% if success %}
    <p class="success">✔ Entry Saved!</p>
{% endif %}
{% if error %}
    <p class="success" style="color:darkred">{{ error }}</p>
{% endif %}

<form method="POST" novalidate>
    <input type="hidden" name="step" value="{{ step }}">
    <input type="hidden" name="category" value="{{ prev_category|default('') }}">
    <input type="hidden" name="difficulty" value="{{ prev_difficulty|default('') }}">
    <input type="hidden" name="correct" value="{{ prev_correct|default('') }}">
    <input type="hidden" name="year" value="{{ prev_year|default('') }}">
    <input type="hidden" name="participant_id" value="{{ participant_id|default('') }}">

    <div style="text-align:center; margin-bottom:12px;">
        <small>Active participant id: <strong>{{ participant_id if participant_id else 'None (will create)' }}</strong></small>
    </div>

    {% if step == 1 %}
        <div class="section">
            <h2>1) Choose Category</h2>
            {% for c in categories %}
                <label style="display:block; margin:8px 0;">
                    <input type="radio" name="category_new" value="{{c}}" required> {{ loop.index }}. {{c}}
                </label>
            {% endfor %}
            <p class="hint">Press number keys or click an option.</p>
            <div style="text-align:center; margin-top:12px;">
                <button type="submit" name="action" value="next">Next ►</button>
            </div>
        </div>

    {% elif step == 2 %}
        <div class="section">
            <h2>2) Choose Difficulty</h2>
            {% for d in difficulties %}
                <label style="display:block; margin:8px 0;">
                    <input type="radio" name="difficulty_new" value="{{d}}" required> {{ loop.index }}. {{d}}
                </label>
            {% endfor %}
            <div style="text-align:center; margin-top:12px;">
                <button type="submit" name="action" value="back">◄ Back</button>
                <button type="submit" name="action" value="next">Next ►</button>
            </div>
        </div>

    {% elif step == 3 %}
        <div class="section">
            <h2>3) Was the answer correct?</h2>
            <label style="display:block; margin:8px 0;">
                <input type="radio" name="correct_new" value="1" required> 1. Correct
            </label>
            <label style="display:block; margin:8px 0;">
                <input type="radio" name="correct_new" value="0" required> 2. Incorrect
            </label>
            <div style="text-align:center; margin-top:12px;">
                <button type="submit" name="action" value="back">◄ Back</button>
                <button type="submit" name="action" value="next">Next ►</button>
            </div>
        </div>

    {% elif step == 4 %}
        <div class="section">
            <h2>4) Student Year (final)</h2>
            {% for y in years %}
                <label style="display:block; margin:8px 0;">
                    <input type="radio" name="year_new" value="{{y}}" required> {{ loop.index }}. {{y}}
                </label>
            {% endfor %}

            <div style="margin-top:18px;">
                <h3>Review</h3>
                <p><strong>Category:</strong> {{ prev_category }}</p>
                <p><strong>Difficulty:</strong> {{ prev_difficulty }}</p>
                <p><strong>Correct:</strong> {% if prev_correct == '1' %}Yes{% elif prev_correct == '0' %}No{% else %}—{% endif %}</p>
                <p><strong>Participant ID:</strong> {{ participant_id if participant_id else '(will create)' }}</p>
            </div>

            <div style="margin-top:12px;">
                <label><strong>After submitting, do:</strong></label><br>
                <label>
                    <input type="radio" name="next_action" value="continue_same" checked>
                    {{ years|length + 1 }}. Continue with the same participant (default)
                </label><br>
                <label>
                    <input type="radio" name="next_action" value="new_and_fill">
                    {{ years|length + 2 }}. Create a new participant and start full form
                </label>
            </div>

            <div style="text-align:center; margin-top:12px;">
                <button type="submit" name="action" value="back">◄ Back</button>
                <button class="submit-btn" type="submit" name="action" value="submit">Submit ✓</button>
            </div>
        </div>
    {% endif %}
</form>

<script>
// Handle numeric shortcuts
document.addEventListener("keydown", (e) => {
    const num = parseInt(e.key);
    const step = parseInt("{{ step }}");

    // Process 1–9 numeric keys for selection
    if (num && num > 0) {
        let buttons = [];

        if (step === 1) {
            buttons = document.querySelectorAll('input[name="category_new"]');
        } else if (step === 2) {
            buttons = document.querySelectorAll('input[name="difficulty_new"]');
        } else if (step === 3) {
            buttons = document.querySelectorAll('input[name="correct_new"]');
        } else if (step === 4) {
            const yearButtons = document.querySelectorAll('input[name="year_new"]');
            const actionButtons = document.querySelectorAll('input[name="next_action"]');

            if (num <= yearButtons.length) {
                yearButtons[num - 1].click();
            } else {
                const actionIndex = num - yearButtons.length - 1;
                if (actionIndex >= 0 && actionIndex < actionButtons.length) {
                    actionButtons[actionIndex].click();
                }
            }
            return;
        }
        if (num <= buttons.length) {
            buttons[num - 1].click();
        }
    }

    // Handle Enter key
    if (e.key === "Enter") {
        const form = e.target.closest("form");
        const nextBtn = document.querySelector('button[name="action"][value="next"]');
        const submitBtn = document.querySelector('button[name="action"][value="submit"]');

        // Check if one of the inputs has been selected
        const selected = document.querySelector("input[type=radio]:checked");

        if (submitBtn && selected) {
            // On final step with a selection → submit
            submitBtn.click();
        } else if (nextBtn && selected) {
            // On intermediate step with a selection → move next
            nextBtn.click();
        } else {
            alert("Please make a selection before continuing.");
        }
        e.preventDefault();
    }
});
</script>

</body>
</html>
